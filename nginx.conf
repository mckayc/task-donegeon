# frontend/nginx.conf

# Sets the number of worker processes. 'auto' is a good default.
worker_processes  auto;

events {
    # Sets the maximum number of simultaneous connections that can be opened by a worker process.
    worker_connections  1024;
}

http {
    # Includes a file that maps file extensions to MIME types.
    include       /etc/nginx/mime.types;
    # Default MIME type to use if a file extension doesn't match anything in mime.types.
    default_type  application/octet-stream;
    
    # Enables more efficient file transmission.
    sendfile        on;
    # How long to keep a connection open for keep-alive requests.
    keepalive_timeout  65;

    # Defines a virtual server to handle requests.
    server {
        # Tells Nginx to listen for incoming connections on port 80 inside the container.
        listen 80;
        
        # The directory where our built React app's files are located.
        root /usr/share/nginx/html;
        
        # The default file to serve if a directory is requested.
        index index.html;

        # This block is the key for Single-Page Applications (SPAs) like React.
        location / {
            # Tries to find a file that matches the request URI. If not found,
            # it tries to find a directory. If that also fails, it serves /index.html.
            # This allows React Router to handle all client-side page routes.
            try_files $uri $uri/ /index.html;
        }

        # This block handles all requests that start with /api/.
        location /api/ {
            # This is the reverse proxy rule. It forwards the request to our backend service.
            # 'http://backend:3000' points to the backend container. 'backend' is the service
            # name from docker-compose.yml, and 3000 is the port our Fastify server listens on.
            proxy_pass http://backend:3000;
            
            # These headers pass along important information about the original request
            # to the backend, which is useful for logging and security.
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }
}